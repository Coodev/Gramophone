package com.orobator.android.gramophone.view.fragments;import android.os.Bundle;import android.support.v4.app.FragmentManager;import android.support.v4.app.ListFragment;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.ArrayAdapter;import android.widget.ListView;import android.widget.SectionIndexer;import android.widget.TextView;import android.widget.Toast;import com.orobator.android.gramophone.R;import com.orobator.android.gramophone.model.Album;import com.orobator.android.gramophone.model.Library;import java.util.ArrayList;import java.util.HashMap;import java.util.Vector;public class AlbumsFragment extends ListFragment {    private static final String TAG = "AlbumsFragment";    private static Library library;    public static final String KEY_ALBUM_NAME = "album name";    public static final String KEY_ALBUM_ARTIST = "album artist";    AlbumAdapter mAdapter;    @Override    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setRetainInstance(true);        library = Library.getLibrary(getActivity().getApplicationContext());        long startTime = System.currentTimeMillis();        mAdapter = new AlbumAdapter(library.getAlbums());        setListAdapter(mAdapter);        long endTime = System.currentTimeMillis();        int albumCount = mAdapter.mAlbums.size();        double timeInSeconds = (endTime - startTime) / 1000.0;        Toast toast = Toast.makeText(getActivity(), "Loaded " + albumCount +                " albums in " + timeInSeconds + " seconds", Toast.LENGTH_LONG);        toast.show();    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup parent, Bundle savedInstanceState) {        View view = inflater.inflate(R.layout.list_view_albums, parent, false);        return view;    }    @Override    public void onListItemClick(ListView listView, View view, int position, long id) {        Album album = (Album) getListAdapter().getItem(position);        Bundle args = new Bundle();        args.putString(KEY_ALBUM_NAME, album.getAlbumName());        args.putString(KEY_ALBUM_ARTIST, album.getAlbumArtist());        AlbumSongsFragment albumSongsFragment = new AlbumSongsFragment();        albumSongsFragment.setArguments(args);        FragmentManager fm = getActivity().getSupportFragmentManager();        fm.beginTransaction()                .replace(R.id.content_frame, albumSongsFragment)                .addToBackStack(album.getAlbumName())                .commit();    }    static class ViewHolder {        TextView albumTitleTextView;        TextView albumArtistTextView;    }    private class AlbumAdapter extends ArrayAdapter<Album> implements SectionIndexer {        private ArrayList<Album> mAlbums;        private Vector<String> mSections;        private HashMap<String, Integer> sectionMap;        public AlbumAdapter(ArrayList<Album> albums) {            super(getActivity(), android.R.layout.simple_list_item_1, albums);            mAlbums = albums;            mSections = new Vector<String>();            sectionMap = new HashMap<String, Integer>();            initializeSections();        }        private void initializeSections() {            for (int i = 0; i < mAlbums.size(); i++) {                String title = mAlbums.get(i).getAlbumName();                if (title.toLowerCase().startsWith("the ")) {                    title = title.substring(3);                }                String firstLetter = title.substring(0, 1).toUpperCase();                Integer myInt = Integer.getInteger(firstLetter);                if (myInt != null) {                    firstLetter = "123";                }                if (!sectionMap.containsKey(firstLetter)) {                    if (startsWithAlphaNum(firstLetter)) {                        sectionMap.put(firstLetter, i);                        mSections.add(firstLetter);                    }                }            }        }        @Override        public View getView(int position, View convertView, ViewGroup parent) {            Album album = getItem(position);            if (convertView == null) {                convertView = getActivity().getLayoutInflater()                        .inflate(R.layout.list_item_album, null);                ViewHolder holder = new ViewHolder();                holder.albumTitleTextView = (TextView) convertView.findViewById(R.id.albumTitle_textView);                holder.albumArtistTextView = (TextView) convertView.findViewById(R.id.albumArtist_textView);                convertView.setTag(holder);            }            ViewHolder holder = (ViewHolder) convertView.getTag();            holder.albumTitleTextView.setText(album.getAlbumName());            holder.albumArtistTextView.setText(album.getAlbumArtist());            return convertView;        }        private boolean startsWithAlphaNum(String str) {            if (str == null) return false;            // TODO Clean up code with REGEX            return !(str.toLowerCase().startsWith("~")                    || str.toLowerCase().startsWith("!")                    || str.toLowerCase().startsWith("@")                    || str.toLowerCase().startsWith("#")                    || str.toLowerCase().startsWith("$")                    || str.toLowerCase().startsWith("%")                    || str.toLowerCase().startsWith("^")                    || str.toLowerCase().startsWith("&")                    || str.toLowerCase().startsWith("*")                    || str.toLowerCase().startsWith("(")                    || str.toLowerCase().startsWith(")")                    || str.toLowerCase().startsWith("_")                    || str.toLowerCase().startsWith("-")                    || str.toLowerCase().startsWith("+")                    || str.toLowerCase().startsWith("=")                    || str.toLowerCase().startsWith("`")                    || str.toLowerCase().startsWith("[")                    || str.toLowerCase().startsWith("]")                    || str.toLowerCase().startsWith("{")                    || str.toLowerCase().startsWith("}")                    || str.toLowerCase().startsWith("\\")                    || str.toLowerCase().startsWith("|")                    || str.toLowerCase().startsWith(":")                    || str.toLowerCase().startsWith(";")                    || str.toLowerCase().startsWith("'")                    || str.toLowerCase().startsWith("\"")                    || str.toLowerCase().startsWith("<")                    || str.toLowerCase().startsWith(">")                    || str.toLowerCase().startsWith(",")                    || str.toLowerCase().startsWith(".")                    || str.toLowerCase().startsWith("?")                    || str.toLowerCase().startsWith("/"));        }        @Override        public Object[] getSections() {            return mSections.toArray();        }        @Override        public int getPositionForSection(int section) {            return sectionMap.get(mSections.get(section));        }        @Override        public int getSectionForPosition(int position) {            Album album = getItem(position);            String title = album.getAlbumName();            String firstLetter = title.substring(0, 1);            for (int i = 0; i < mSections.size(); i++) {                if (firstLetter.equals(mSections.get(i))) {                    return i;                }            }            return 0;        }    }}