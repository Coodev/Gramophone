package com.orobator.android.gramophone.view.fragments;import android.os.Bundle;import android.support.v4.app.FragmentManager;import android.support.v4.app.ListFragment;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.ArrayAdapter;import android.widget.ListView;import android.widget.SectionIndexer;import android.widget.TextView;import com.orobator.android.gramophone.R;import com.orobator.android.gramophone.model.Library;import java.util.ArrayList;import java.util.HashMap;import java.util.Vector;public class GenresFragment extends ListFragment {    public static final String TAG = "GenresFragment";    public static final String KEY_FOR_GENRE = "com.orobator.android.gramophone.genreKey";    GenreAdapter mAdapter;    @Override    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setRetainInstance(true);        Library library = Library.getLibrary(getActivity().getApplicationContext());        long startTime = System.currentTimeMillis();        mAdapter = new GenreAdapter(library.getGenres());        setListAdapter(mAdapter);        long endTime = System.currentTimeMillis();        int genreCount = mAdapter.mGenres.size();        double timeInSeconds = (endTime - startTime) / 1000.0;        Log.i(TAG, "Loaded " + genreCount + " genres in " + timeInSeconds + " seconds");    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup parent, Bundle savedInstanceState) {        View view = inflater.inflate(R.layout.list_view_genres, parent, false);        return view;    }    @Override    public void onListItemClick(ListView listView, View view, int position, long id) {        String genre = (String) getListAdapter().getItem(position);        Bundle args = new Bundle();        args.putString(KEY_FOR_GENRE, genre);        GenreSongsFragment fragment = new GenreSongsFragment();        fragment.setArguments(args);        FragmentManager fm = getActivity().getSupportFragmentManager();        fm.beginTransaction()                .replace(R.id.content_frame, fragment)                .addToBackStack(genre)                .commit();    }    static class ViewHolder {        TextView genreTextView;    }    private class GenreAdapter extends ArrayAdapter<String> implements SectionIndexer {        private ArrayList<String> mGenres;        private Vector<String> mSections;        private HashMap<String, Integer> sectionMap;        public GenreAdapter(ArrayList<String> genres) {            super(getActivity(), android.R.layout.simple_list_item_1, genres);            mGenres = genres;            mSections = new Vector<String>();            sectionMap = new HashMap<String, Integer>();            initializeSections();        }        private void initializeSections() {            for (int i = 0; i < mGenres.size(); i++) {                String title = mGenres.get(i);                String firstLetter = title.substring(0, 1).toUpperCase();                Integer myInt = Integer.getInteger(firstLetter);                if (myInt != null) {                    firstLetter = "123";                }                if (!sectionMap.containsKey(firstLetter)) {                    if (startsWithAlphaNum(firstLetter)) {                        sectionMap.put(firstLetter, i);                        mSections.add(firstLetter);                    }                }            }        }        private boolean startsWithAlphaNum(String str) {            if (str == null) return false;            // TODO Clean up code with REGEX            return !(str.toLowerCase().startsWith("~")                    || str.toLowerCase().startsWith("!")                    || str.toLowerCase().startsWith("@")                    || str.toLowerCase().startsWith("#")                    || str.toLowerCase().startsWith("$")                    || str.toLowerCase().startsWith("%")                    || str.toLowerCase().startsWith("^")                    || str.toLowerCase().startsWith("&")                    || str.toLowerCase().startsWith("*")                    || str.toLowerCase().startsWith("(")                    || str.toLowerCase().startsWith(")")                    || str.toLowerCase().startsWith("_")                    || str.toLowerCase().startsWith("-")                    || str.toLowerCase().startsWith("+")                    || str.toLowerCase().startsWith("=")                    || str.toLowerCase().startsWith("`")                    || str.toLowerCase().startsWith("[")                    || str.toLowerCase().startsWith("]")                    || str.toLowerCase().startsWith("{")                    || str.toLowerCase().startsWith("}")                    || str.toLowerCase().startsWith("\\")                    || str.toLowerCase().startsWith("|")                    || str.toLowerCase().startsWith(":")                    || str.toLowerCase().startsWith(";")                    || str.toLowerCase().startsWith("'")                    || str.toLowerCase().startsWith("\"")                    || str.toLowerCase().startsWith("<")                    || str.toLowerCase().startsWith(">")                    || str.toLowerCase().startsWith(",")                    || str.toLowerCase().startsWith(".")                    || str.toLowerCase().startsWith("?")                    || str.toLowerCase().startsWith("/"));        }        @Override        public View getView(int position, View convertView, ViewGroup parent) {            String genre = getItem(position);            if (convertView == null) {                convertView = getActivity().getLayoutInflater()                        .inflate(R.layout.list_item_genre, null);                ViewHolder holder = new ViewHolder();                holder.genreTextView = (TextView) convertView.findViewById(R.id.genre_textView);                convertView.setTag(holder);            }            ViewHolder holder = (ViewHolder) convertView.getTag();            holder.genreTextView.setText(genre);            return convertView;        }        @Override        public Object[] getSections() {            return mSections.toArray();        }        @Override        public int getPositionForSection(int section) {            return sectionMap.get(mSections.get(section));        }        @Override        public int getSectionForPosition(int position) {            String title = getItem(position);            String firstLetter = title.substring(0, 1);            for (int i = 0; i < mSections.size(); i++) {                if (firstLetter.equals(mSections.get(i))) {                    return i;                }            }            return 0;        }    }}